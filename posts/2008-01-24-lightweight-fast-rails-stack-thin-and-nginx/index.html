<!doctype html><html lang=en-us><head><title>Lightweight, fast Rails stack - Thin & nginx // Jason Madigan</title>
<link rel="shortcut icon" href=/favicon.ico><meta charset=utf-8><meta name=generator content="Hugo 0.140.2"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Jason Madigan"><meta name=description content><link rel=stylesheet href=/css/main.min.5b1fcc8902588589c4767187402a3c29f8b8d7a6fdef6d9f8f77045bb0d14fee.css><meta name=twitter:card content="summary"><meta name=twitter:title content="Lightweight, fast Rails stack - Thin & nginx"><meta name=twitter:description content="Since purchasing a slice of heaven a few days ago, I’ve setup a very lightweight Rails stack consisting of Thin & nginx for my Rails needs. Since I went for a slice with just 256MB of RAM, memory consumption becomes a pretty serious issue. nginx has been around for quite a while now, and has recently started to become more and more popular in Rails deployments due to the fact that’s incredibly lightweight, very fast and stable - perfect not only for VPS jerks like me, but for anyone who really doesn’t feel it’s necessary to run Apache for static content/cluster proxying/load balancing. Thin is something I came across very recently and I decided to try is as a replacement for mongrel since I’d heard some great things about it, even if it is still alpha. It’s performance in comparison to mongrel (even with a tacked on event machine) looks very impressive on paper."><meta property="og:url" content="/posts/2008-01-24-lightweight-fast-rails-stack-thin-and-nginx/"><meta property="og:site_name" content="Jason Madigan"><meta property="og:title" content="Lightweight, fast Rails stack - Thin & nginx"><meta property="og:description" content="Since purchasing a slice of heaven a few days ago, I’ve setup a very lightweight Rails stack consisting of Thin & nginx for my Rails needs. Since I went for a slice with just 256MB of RAM, memory consumption becomes a pretty serious issue. nginx has been around for quite a while now, and has recently started to become more and more popular in Rails deployments due to the fact that’s incredibly lightweight, very fast and stable - perfect not only for VPS jerks like me, but for anyone who really doesn’t feel it’s necessary to run Apache for static content/cluster proxying/load balancing. Thin is something I came across very recently and I decided to try is as a replacement for mongrel since I’d heard some great things about it, even if it is still alpha. It’s performance in comparison to mongrel (even with a tacked on event machine) looks very impressive on paper."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2008-01-24T21:00:00+00:00"><meta property="article:modified_time" content="2008-01-24T21:00:00+00:00"></head><body><header class=app-header><a href=/><img class=app-header-avatar src=/0.jpg alt="Jason Madigan"></a>
<span class=app-header-title>Jason Madigan</span><nav class=app-header-menu><a class=app-header-menu-item href=/about/>About</a></nav><p>He's just zis guy, ya know?</p><div class=app-header-social><a href=https://github.com/jasonmadigan target=_blank rel="noreferrer noopener me"><svg viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-link"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"/></svg>
</a><a href=https://twitter.com/jasonmadigan target=_blank rel="noreferrer noopener me"><svg viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-link"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"/></svg></a></div></header><main class=app-container><article class=post><header class=post-header><h1 class=post-title>Lightweight, fast Rails stack - Thin & nginx</h1><div class=post-meta><div><svg class="icon icon-calendar" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><title>calendar</title><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
Jan 24, 2008</div><div><svg class="icon icon-clock" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><title>clock</title><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
3 min read</div></div></header><div class=post-content><p>Since purchasing a
<a href=http://www.slicehost.com title=http://www.slicehost.com>slice
of heaven</a> a few days ago, I&rsquo;ve setup a very lightweight Rails stack
consisting of
<a href=http://code.macournoyer.com/thin/ title=http://code.macournoyer.com/thin/>Thin</a>
& <a href=http://nginx.net/ title=http://nginx.net/>nginx</a> for my
Rails needs. Since I went for a slice with just 256MB of RAM, memory
consumption becomes a pretty serious issue. nginx has been around for
quite a while now, and has recently started to become more and more
popular in Rails deployments due to the fact that&rsquo;s incredibly
lightweight, very fast and stable - perfect not only for VPS jerks like
me, but for anyone who really doesn&rsquo;t feel it&rsquo;s necessary to run Apache
for static content/cluster proxying/load balancing. Thin is something I
came across very recently and I decided to try is as a replacement for
mongrel since I&rsquo;d heard some great things about it, even if it is still
alpha. It&rsquo;s performance in comparison to mongrel (even with a tacked on
event machine) looks very impressive on paper.</p><p>Setting up clustering with it is a snap, just spawn the processes and
pipe them into nginx. Here&rsquo;s a startup script borrowed from
<a href=http://groups.google.com/group/thin-ruby/msg/7775cc00e316b25a title=http://groups.google.com/group/thin-ruby/msg/7775cc00e316b25a>Stephen
Celis</a>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span>namespace <span style=color:#e6db74>:thin</span> <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span> namespace <span style=color:#e6db74>:cluster</span> <span style=color:#66d9ef>do</span> desc <span style=color:#e6db74>&#39;Start thin cluster&#39;</span>
</span></span><span style=display:flex><span> task <span style=color:#e6db74>:start</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>:environment</span> <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span> <span style=color:#e6db74>`cd </span><span style=color:#e6db74>#{</span><span style=color:#66d9ef>RAILS_ROOT</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span> port_range <span style=color:#f92672>=</span> <span style=color:#66d9ef>RAILS_ENV</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;development&#39;</span> ? <span style=color:#ae81ff>3</span> : <span style=color:#ae81ff>8</span>
</span></span><span style=display:flex><span> (<span style=color:#66d9ef>ENV</span><span style=color:#f92672>[</span><span style=color:#e6db74>&#39;SIZE&#39;</span><span style=color:#f92672>]</span> ? <span style=color:#66d9ef>ENV</span><span style=color:#f92672>[</span><span style=color:#e6db74>&#39;SIZE&#39;</span><span style=color:#f92672>].</span>to_i : <span style=color:#ae81ff>4</span>)<span style=color:#f92672>.</span>times <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span>i<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span> <span style=color:#66d9ef>Thread</span><span style=color:#f92672>.</span>new <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span> port <span style=color:#f92672>=</span> <span style=color:#66d9ef>ENV</span><span style=color:#f92672>[</span><span style=color:#e6db74>&#39;PORT&#39;</span><span style=color:#f92672>]</span> ? <span style=color:#66d9ef>ENV</span><span style=color:#f92672>[</span><span style=color:#e6db74>&#39;PORT&#39;</span><span style=color:#f92672>].</span>to_i <span style=color:#f92672>+</span> i : (<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>#{</span>port_range<span style=color:#e6db74>}</span><span style=color:#e6db74>%03d&#34;</span>  i)
</span></span><span style=display:flex><span>          str  <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;thin start -d -p</span><span style=color:#e6db74>#{</span>port<span style=color:#e6db74>}</span><span style=color:#e6db74> -Ptmp/pids/thin-</span><span style=color:#e6db74>#{</span>port<span style=color:#e6db74>}</span><span style=color:#e6db74>.pid&#34;</span>
</span></span><span style=display:flex><span>          str <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#34; -e</span><span style=color:#e6db74>#{</span><span style=color:#66d9ef>RAILS_ENV</span><span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>          puts str
</span></span><span style=display:flex><span>          puts <span style=color:#e6db74>&#34;Starting server on port </span><span style=color:#e6db74>#{</span>port<span style=color:#e6db74>}</span><span style=color:#e6db74>...&#34;</span>
</span></span><span style=display:flex><span>          <span style=color:#e6db74>`</span><span style=color:#e6db74>#{</span>str<span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>    desc <span style=color:#e6db74>&#39;Stop all thin clusters&#39;</span>
</span></span><span style=display:flex><span>    task <span style=color:#e6db74>:stop</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>:environment</span> <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>`cd </span><span style=color:#e6db74>#{</span><span style=color:#66d9ef>RAILS_ROOT</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>Dir</span><span style=color:#f92672>.</span>new(<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>#{</span><span style=color:#66d9ef>RAILS_ROOT</span><span style=color:#e6db74>}</span><span style=color:#e6db74>/tmp/pids&#34;</span>)<span style=color:#f92672>.</span>each <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span>file<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>Thread</span><span style=color:#f92672>.</span>new <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>if</span> file<span style=color:#f92672>.</span>starts_with?(<span style=color:#e6db74>&#34;thin-&#34;</span>)
</span></span><span style=display:flex><span>            str  <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;thin stop -Ptmp/pids/</span><span style=color:#e6db74>#{</span>file<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>            puts <span style=color:#e6db74>&#34;Stopping server on port </span><span style=color:#e6db74>#{</span>file<span style=color:#f92672>[</span><span style=color:#e6db74>/\d+/</span><span style=color:#f92672>]</span><span style=color:#e6db74>}</span><span style=color:#e6db74>...&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>`</span><span style=color:#e6db74>#{</span>str<span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>Then spawn however many processes you want using something like:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>rake thin:cluster:start RAILS_ENV<span style=color:#f92672>=</span>production SIZE<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span> PORT<span style=color:#f92672>=</span><span style=color:#ae81ff>3000</span>
</span></span></code></pre></div><p>To stop them, use:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>rake thin:cluster:stop
</span></span></code></pre></div><p>With that all nicely setup, you can use an nginx config similar to mine to get things in order:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=display:flex><span><span style=color:#66d9ef>upstream</span> <span style=color:#e6db74>dapperjerk</span> {
</span></span><span style=display:flex><span>  <span style=color:#f92672>server</span> 127.0.0.1:<span style=color:#ae81ff>3000</span>;
</span></span><span style=display:flex><span>  <span style=color:#f92672>server</span> 127.0.0.1:<span style=color:#ae81ff>3001</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>server</span> {
</span></span><span style=display:flex><span>  <span style=color:#f92672>listen</span> <span style=color:#ae81ff>80</span>;
</span></span><span style=display:flex><span>  <span style=color:#f92672>server_name</span>  <span style=color:#e6db74>www.dapperjerk.com</span>;
</span></span><span style=display:flex><span>  <span style=color:#f92672>rewrite</span> <span style=color:#e6db74>\^/(.\*)</span> <span style=color:#e6db74>http://dapperjerk.com</span> <span style=color:#e6db74>permanent</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>server</span> {
</span></span><span style=display:flex><span>  <span style=color:#f92672>listen</span>   <span style=color:#ae81ff>80</span>;
</span></span><span style=display:flex><span>  <span style=color:#f92672>server_name</span> <span style=color:#e6db74>dapperjerk.com</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>access_log</span> <span style=color:#e6db74>/home/jason/public_html/blog/log/access.log</span>;
</span></span><span style=display:flex><span>  <span style=color:#f92672>error_log</span> <span style=color:#e6db74>/home/jason/public_html/blog/log/error.log</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>root</span>   <span style=color:#e6db74>/home/jason/public_html/blog/public/</span>;
</span></span><span style=display:flex><span>  <span style=color:#f92672>index</span>  <span style=color:#e6db74>index.html</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>location</span> <span style=color:#e6db74>/</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>proxy_set_header</span>  <span style=color:#e6db74>X-Real-IP</span>  $remote_addr;
</span></span><span style=display:flex><span>    <span style=color:#f92672>proxy_set_header</span>  <span style=color:#e6db74>X-Forwarded-For</span> $proxy_add_x_forwarded_for;
</span></span><span style=display:flex><span>    <span style=color:#f92672>proxy_set_header</span> <span style=color:#e6db74>Host</span> $http_host;
</span></span><span style=display:flex><span>    <span style=color:#f92672>proxy\_redirect</span> <span style=color:#e6db74>false</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>if</span> <span style=color:#e6db74>(-f</span> $request_filename/index.html<span style=color:#e6db74>)</span> {
</span></span><span style=display:flex><span>      <span style=color:#f92672>rewrite</span> <span style=color:#e6db74>(.*)</span> $1/index.html <span style=color:#e6db74>break</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>if</span> <span style=color:#e6db74>(-f</span> $request_filename.html<span style=color:#e6db74>)</span> {
</span></span><span style=display:flex><span>      <span style=color:#f92672>rewrite</span> <span style=color:#e6db74>(.*)</span> $1.html <span style=color:#e6db74>break</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>if</span> <span style=color:#e6db74>(!-f</span> $request_filename<span style=color:#e6db74>)</span> {
</span></span><span style=display:flex><span>      <span style=color:#f92672>proxy_pass</span> <span style=color:#e6db74>http://dapperjerk</span>;
</span></span><span style=display:flex><span>      <span style=color:#f92672>break</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>And that&rsquo;s really all there is too it. I&rsquo;m not a masochist so I&rsquo;ve never
bothered to fully read Apache&rsquo;s documentation, but I don&rsquo;t think I&rsquo;m
going out on a limb here by saying that it seems to be a lot easier to
manage nginx. I haven&rsquo;t really put thin through its paces yet, but we&rsquo;ll
see in the coming weeks as I cobble together a custom blog app to run
this place.</p></div><div class=post-footer></div></article></main></body></html>